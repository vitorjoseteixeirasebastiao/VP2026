<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Vagas</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

#map {
  width: 100%;
  height: 100vh;
}

.top-bar {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 20px);
  max-width: 520px;
  display: flex;
  gap: 6px;
  z-index: 2000;
}

#searchInput {
  flex: 1;
  padding: 12px;
  font-size: 16px;
}

#btnBuscar,
#btnCentralizar {
  padding: 12px 14px;
  font-size: 16px;
  cursor: pointer;
}

#suggestions {
  position: absolute;
  top: 52px;
  left: 0;
  width: 100%;
  background: white;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
  z-index: 3000;
}

.suggestion {
  padding: 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.suggestion:last-child {
  border-bottom: none;
}

.suggestion:hover {
  background: #f0f0f0;
}
</style>

</head>
<body>

<div class="top-bar">
  <input id="searchInput" type="text" placeholder="Buscar endere√ßo">
  <button id="btnBuscar">Buscar</button>
  <button id="btnCentralizar" title="Minha localiza√ß√£o">üìç</button>
  <div id="suggestions"></div>
</div>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- KML plugin -->
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

<script type="module">

// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_KEY",
  authDomain: "vpm2026-8167b.firebaseapp.com",
  projectId: "vpm2026-8167b",
  storageBucket: "vpm2026-8167b.firebasestorage.app",
  messagingSenderId: "129557498750",
  appId: "1:129557498750:web:c2a510c04946583a17412f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colecao = "marcadores";

// ===== Mapa =====
const map = L.map("map").setView([0, 0], 15);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

// ===== √çcone usu√°rio =====
const iconeUsuario = L.divIcon({
  className: "",
  html: `<div style="width:16px;height:16px;background:#007bff;border:3px solid white;border-radius:50%;"></div>`,
  iconSize: [16,16],
  iconAnchor: [8,8]
});

const marcadorUsuario = L.marker([0,0], { icon: iconeUsuario }).addTo(map);

let posicaoAtual = null;
let primeira = true;

// ===== GPS =====
navigator.geolocation.watchPosition(pos => {
  posicaoAtual = {
    lat: pos.coords.latitude,
    lng: pos.coords.longitude
  };

  marcadorUsuario.setLatLng([posicaoAtual.lat, posicaoAtual.lng]);

  if (primeira) {
    map.setView([posicaoAtual.lat, posicaoAtual.lng], 18);
    primeira = false;
  }
}, err => {
  console.error(err);
}, { enableHighAccuracy: true });

// ===== Centralizar =====
document.getElementById("btnCentralizar").onclick = () => {
  if (posicaoAtual) {
    map.setView([posicaoAtual.lat, posicaoAtual.lng], 18);
  }
};

// ===== Popup =====
function popupConteudo(endereco, lat, lng) {
  return `
    <b>${endereco}</b><br><br>
    <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank">
      Abrir no Waze
    </a>
  `;
}

// ===== Carregar marcadores Firebase =====
async function carregarMarcadores() {
  const snap = await getDocs(collection(db, colecao));
  snap.forEach(doc => {
    const d = doc.data();
    L.marker([d.latitude, d.longitude])
      .addTo(map)
      .bindPopup(popupConteudo(d.endereco, d.latitude, d.longitude));
  });
}

carregarMarcadores();

// ===== Busca =====
const searchInput = document.getElementById("searchInput");
const btnBuscar = document.getElementById("btnBuscar");
const suggestions = document.getElementById("suggestions");

btnBuscar.onclick = async () => {
  const q = searchInput.value.trim();
  if (!q) return;

  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=2&q=${encodeURIComponent(q)}`;
  const res = await fetch(url);
  const data = await res.json();

  suggestions.innerHTML = "";

  data.forEach(item => {
    const div = document.createElement("div");
    div.className = "suggestion";
    div.textContent = item.display_name;

    div.onclick = () => {
      map.setView([item.lat, item.lon], 18);
      suggestions.innerHTML = "";
    };

    suggestions.appendChild(div);
  });
};

// ===== KML Zona Azul =====
const camadaZonaAzul = omnivore.kml("ZonaAzul.kml")
  .on("ready", function () {
    console.log("ZonaAzul carregado");
  })
  .on("error", function (err) {
    console.error("Erro ao carregar ZonaAzul:", err);
  })
  .addTo(map);

</script>

</body>
</html>
